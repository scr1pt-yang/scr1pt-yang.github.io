<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>AOF持久化 | Wiki知识库</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/logo.png">
    <meta name="description" content="纵有疾风起，人生不言弃">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.855c2202.css" as="style"><link rel="preload" href="/assets/js/app.b91711c7.js" as="script"><link rel="preload" href="/assets/js/7.9d515fbf.js" as="script"><link rel="preload" href="/assets/js/2.5da332ff.js" as="script"><link rel="preload" href="/assets/js/1.4298cda3.js" as="script"><link rel="preload" href="/assets/js/67.85226520.js" as="script"><link rel="prefetch" href="/assets/js/10.d355181a.js"><link rel="prefetch" href="/assets/js/11.8134c8e9.js"><link rel="prefetch" href="/assets/js/14.b0d5c555.js"><link rel="prefetch" href="/assets/js/15.ccee4aa5.js"><link rel="prefetch" href="/assets/js/16.c1837ea3.js"><link rel="prefetch" href="/assets/js/17.25ce5de6.js"><link rel="prefetch" href="/assets/js/18.975768de.js"><link rel="prefetch" href="/assets/js/19.41d12e27.js"><link rel="prefetch" href="/assets/js/20.c933e526.js"><link rel="prefetch" href="/assets/js/21.0c7ffc83.js"><link rel="prefetch" href="/assets/js/22.ce27a662.js"><link rel="prefetch" href="/assets/js/23.1956bc99.js"><link rel="prefetch" href="/assets/js/24.a9868885.js"><link rel="prefetch" href="/assets/js/25.d4488dc7.js"><link rel="prefetch" href="/assets/js/26.dcece5f0.js"><link rel="prefetch" href="/assets/js/27.bbdc0b8a.js"><link rel="prefetch" href="/assets/js/28.b2aedd35.js"><link rel="prefetch" href="/assets/js/29.acfc3a3b.js"><link rel="prefetch" href="/assets/js/3.13a69347.js"><link rel="prefetch" href="/assets/js/30.84c3f959.js"><link rel="prefetch" href="/assets/js/31.31ae9989.js"><link rel="prefetch" href="/assets/js/32.581577ae.js"><link rel="prefetch" href="/assets/js/33.944c0534.js"><link rel="prefetch" href="/assets/js/34.a4aa8037.js"><link rel="prefetch" href="/assets/js/35.57055faf.js"><link rel="prefetch" href="/assets/js/36.c04313ea.js"><link rel="prefetch" href="/assets/js/37.03d0ce84.js"><link rel="prefetch" href="/assets/js/38.adfa6339.js"><link rel="prefetch" href="/assets/js/39.408c0071.js"><link rel="prefetch" href="/assets/js/4.1112ff6a.js"><link rel="prefetch" href="/assets/js/40.ee24e9e8.js"><link rel="prefetch" href="/assets/js/41.9f5d89de.js"><link rel="prefetch" href="/assets/js/42.b713072b.js"><link rel="prefetch" href="/assets/js/43.50b9023f.js"><link rel="prefetch" href="/assets/js/44.9408f400.js"><link rel="prefetch" href="/assets/js/45.66484097.js"><link rel="prefetch" href="/assets/js/46.a8c56999.js"><link rel="prefetch" href="/assets/js/47.02561748.js"><link rel="prefetch" href="/assets/js/48.c444a6c2.js"><link rel="prefetch" href="/assets/js/49.5da9d159.js"><link rel="prefetch" href="/assets/js/5.7f78909b.js"><link rel="prefetch" href="/assets/js/50.dd33d1e1.js"><link rel="prefetch" href="/assets/js/51.3021f459.js"><link rel="prefetch" href="/assets/js/52.d6bb03b4.js"><link rel="prefetch" href="/assets/js/53.ddb0b5b4.js"><link rel="prefetch" href="/assets/js/54.eae38949.js"><link rel="prefetch" href="/assets/js/55.b48f6372.js"><link rel="prefetch" href="/assets/js/56.b047cdc3.js"><link rel="prefetch" href="/assets/js/57.06e4776f.js"><link rel="prefetch" href="/assets/js/58.61ab626d.js"><link rel="prefetch" href="/assets/js/59.01b5f5a5.js"><link rel="prefetch" href="/assets/js/6.a8de1a57.js"><link rel="prefetch" href="/assets/js/60.e3bf72a0.js"><link rel="prefetch" href="/assets/js/61.063384cd.js"><link rel="prefetch" href="/assets/js/62.6dba9a2d.js"><link rel="prefetch" href="/assets/js/63.4a797bc8.js"><link rel="prefetch" href="/assets/js/64.525591b0.js"><link rel="prefetch" href="/assets/js/65.d21c9ee5.js"><link rel="prefetch" href="/assets/js/66.8321b932.js"><link rel="prefetch" href="/assets/js/68.ae5ddf2c.js"><link rel="prefetch" href="/assets/js/69.81bbd6d3.js"><link rel="prefetch" href="/assets/js/70.a8fc8534.js"><link rel="prefetch" href="/assets/js/71.12c3e024.js"><link rel="prefetch" href="/assets/js/72.699b211f.js"><link rel="prefetch" href="/assets/js/73.b309b6c6.js"><link rel="prefetch" href="/assets/js/74.93cc03dd.js"><link rel="prefetch" href="/assets/js/75.8c2e27e1.js"><link rel="prefetch" href="/assets/js/76.dd3177c3.js"><link rel="prefetch" href="/assets/js/77.bfbf8f8f.js"><link rel="prefetch" href="/assets/js/78.43d9fbf2.js"><link rel="prefetch" href="/assets/js/79.01c5b56f.js"><link rel="prefetch" href="/assets/js/8.4ec37cc7.js"><link rel="prefetch" href="/assets/js/80.987c4695.js"><link rel="prefetch" href="/assets/js/81.8dd69880.js"><link rel="prefetch" href="/assets/js/82.2dae0764.js"><link rel="prefetch" href="/assets/js/83.ddeca976.js"><link rel="prefetch" href="/assets/js/84.83c16b17.js"><link rel="prefetch" href="/assets/js/85.36c6e0cd.js"><link rel="prefetch" href="/assets/js/86.7f807c97.js"><link rel="prefetch" href="/assets/js/87.745a54cc.js"><link rel="prefetch" href="/assets/js/9.e51dbdf5.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.a372b0f4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.855c2202.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Wiki知识库</h3> <p class="description" data-v-59e6cb88>纵有疾风起，人生不言弃</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Scr1Pt</span>
          
        <!---->
        2024
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Wiki知识库</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      中间件
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/nginx/" class="nav-link"><i class="iconfont reco-document"></i>
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/pages/redis/" class="nav-link router-link-active"><i class="iconfont reco-document"></i>
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/pages/rabbitmq/" class="nav-link"><i class="iconfont reco-document"></i>
  RabbitMQ
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      云原生
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/docker/" class="nav-link"><i class="iconfont reco-document"></i>
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/" class="nav-link"><i class="iconfont reco-document"></i>
  Kubernetes
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/scr1pt-yang" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub地址
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/头像.png" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    Scr1Pt
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>49</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>5</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      中间件
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/nginx/" class="nav-link"><i class="iconfont reco-document"></i>
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/pages/redis/" class="nav-link router-link-active"><i class="iconfont reco-document"></i>
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/pages/rabbitmq/" class="nav-link"><i class="iconfont reco-document"></i>
  RabbitMQ
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      云原生
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/docker/" class="nav-link"><i class="iconfont reco-document"></i>
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/" class="nav-link"><i class="iconfont reco-document"></i>
  Kubernetes
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/scr1pt-yang" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub地址
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>笔记简介</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/redis/" aria-current="page" class="sidebar-link">概述</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Redis基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Redis操作命令</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Redis底层数据结构</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Redis持久化</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/redis/Redis持久化技术.html" class="sidebar-link">16.Redis持久化技术</a></li><li><a href="/pages/redis/RDB持久化.html" class="sidebar-link">17.RDB持久化</a></li><li><a href="/pages/redis/AOF持久化.html" class="active sidebar-link">18.AOF持久化</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Redis主从集群</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>AOF持久化</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Scr1Pt</span>
          
        <!---->
        2024
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">AOF持久化</h1> <div data-v-31f39441><i class="iconfont reco-account" data-v-31f39441><span data-v-31f39441>Scr1Pt</span></i> <i class="iconfont reco-date" data-v-31f39441><span data-v-31f39441>11/26/2023</span></i> <i class="iconfont reco-eye" data-v-31f39441><span id="/pages/redis/AOF%E6%8C%81%E4%B9%85%E5%8C%96.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-31f39441><a class="leancloud-visitors-count" style="font-size:1rem;font-weight:700;color:#999;"></a></span></i> <i class="tags iconfont reco-tag" data-v-31f39441><span class="tag-item" data-v-31f39441>缓存Redis</span></i></div></div> <div class="theme-reco-content content__default"><hr> <p>AOF，Append Only File，是指 Redis 将每一次的写操作都以日志的形式记录到一个 AOF文件中的持久化技术。当需要恢复内存数据时，将这些写操作重新执行一次，便会恢复到之前的内存数据状态。</p> <h1 id="一、aof基础配置"><a href="#一、aof基础配置" class="header-anchor">#</a> 一、AOF基础配置</h1> <h2 id="_1、开启aof持久化"><a href="#_1、开启aof持久化" class="header-anchor">#</a> 1、开启AOF持久化</h2> <p><img src="https://cdn.jsdelivr.net/gh/scr1pt-yang/mypichost@main/img/redis-126.png" alt="image.png"><br>默认情况下 AOF 持久化是没有开启的，redis使用的是RDB持久化，可以通过修改配置文件中的 appendonly 属性为yes开启AOF持久化。</p> <h2 id="_2、文件名配置"><a href="#_2、文件名配置" class="header-anchor">#</a> 2、文件名配置</h2> <p><img src="https://cdn.jsdelivr.net/gh/scr1pt-yang/mypichost@main/img/redis-127.png" alt="image.png"><br>Redis 7 在这里发生了重大变化。原来只有一个 appendonly.aof 文件，现在具有多个文件，包括以下三类：<br>● 基本文件（base）：可以是RDB 格式也可以是AOF 格式。其存放的内容是由 RDB 转为 AOF 当时内存的快照数据。该文件可以有多个。<br>● 增量文件（incr）：以操作日志形式记录转为 AOF 后的写入操作。该文件可以有多个。<br>● 清单文件（manifest）：用于维护 AOF 文件的创建顺序，保障激活时的应用顺序。该文件只有一个。</p> <h2 id="_3、混合式持久化"><a href="#_3、混合式持久化" class="header-anchor">#</a> 3、混合式持久化</h2> <p><img src="https://cdn.jsdelivr.net/gh/scr1pt-yang/mypichost@main/img/redis-128.png" alt="image.png"><br>对于基本文件可以是 RDF 格式也可以是 AOF 格式。通过 aof-use-rdb-preamble 属性可以选择。其默认值为yes，即默认 AOF 持久化的基本文件为rdb 格式文件，也就是默认采用混合式持久化。</p> <h2 id="_4、aof-文件目录配置"><a href="#_4、aof-文件目录配置" class="header-anchor">#</a> 4、AOF 文件目录配置</h2> <p><img src="https://cdn.jsdelivr.net/gh/scr1pt-yang/mypichost@main/img/redis-129.png" alt="image.png"><br>为了方便管理，可以专门为 AOF 持久化文件指定存放目录。目录名由 appenddirname属性指定，存放在redis.conf 配置文件的 dir 属性指定的目录，默认为 Redis 安装目录。上述指定了appenddirname的值为appendonlydir，则会在Redis的安装目录下新建一个appendonlydir文件夹存放AOF持久化文件。</p> <h1 id="二、aof文件格式"><a href="#二、aof文件格式" class="header-anchor">#</a> 二、AOF文件格式</h1> <p>AOF 文件包含三类文件：基本文件、增量文件与清单文件。其中基本文件一般为rdb 格式，在前面已经研究过了。下面来看一下增量文件与清单文件的内容格式。</p> <h2 id="_1、redis协议"><a href="#_1、redis协议" class="header-anchor">#</a> 1、Redis协议</h2> <p>增量文件的扩展名为.aof，采用 AOF 格式。AOF 格式其实就是Redis 通讯协议格式，AOF 持久化文件的本质就是基于 Redis 通讯协议的文本，将命令以纯文本的方式写入到文件中。<br>Redis 协议规定，Redis 文本是以行来划分，每行以\r\n 结束。每一行都有一个消息头，以表示消息类型。消息头由六种不同的符号表示，其意义如下：<br>●  (+)  表示一个正确的状态信息；<br>●  (-)   表示一个错误信息；<br>●  (*)  表示消息体总共有多少行，不包括当前行；<br>●  ($)  表示下一行消息数据的长度，不包括换行符长度\r\n；<br>●  (空)  表示一个消息数据；<br>●  (：)  表示返回一个数值。</p> <h2 id="_2、查看aof文件"><a href="#_2、查看aof文件" class="header-anchor">#</a> 2、查看AOF文件</h2> <p>打开 appendonly.aof.1.incr.aof 文件，可以看到如下格式内容。<br><img src="https://cdn.jsdelivr.net/gh/scr1pt-yang/mypichost@main/img/redis-130.png" alt="image.png"><br>以上内容中框起来的是三条命令。一条数据库切换命令 SELECT 0，两条 set 命令。它们的意义如下：</p> <div class="custom-block tip"><p class="title"></p><p>*2                --  表示当前命令包含 2 个参数<br>
$6                --  表示第 1 个参数包含 6 个字符<br>
SELECT        --  第 1 个参数<br>
$1                --  表示第 2 个参数包含 1 个字符<br>
0                  --  第 2 个参数<br>
*3                --  表示当前命令包含 3 个参数<br>
$3                --  表示第 1 个参数包含 3 个字符<br>
set               --  第 1 个参数<br>
$3                --  表示第 2 个参数包含 3 个字符<br>
k11              --  第 2 个参数<br>
$3                --  表示第 3 个参数包含 2 个字符<br>
v11              --  第 3 个参数<br></p></div><h2 id="_3、查看清单文件"><a href="#_3、查看清单文件" class="header-anchor">#</a> 3、查看清单文件</h2> <p>打开清单文件 appendonly.aof.manifest，查看其内容如下：<br><img src="https://cdn.jsdelivr.net/gh/scr1pt-yang/mypichost@main/img/redis-131.png" alt="image.png"><br>该文件首先会按照 seq 序号列举出所有基本文件，基本文件 type 类型为 b，然后再按照 seq 序号再列举出所有增量文件，增量文件 type 类型为 i。<br>对于 Redis 启动时的数据恢复，也会按照该文件由上到下依次加载它们中的数据。</p> <h1 id="三、rewrite机制"><a href="#三、rewrite机制" class="header-anchor">#</a> 三、Rewrite机制</h1> <p>通过前面的学习可以知道，Redis随着写入数据的增多，AOF文件中写入的内容也会越来越多，随着使用时间的推移，AOF 文件会越来越大。为了防止 AOF 文件由于太大而占用大量的磁盘空间，降低性能， Redis 引入了 Rewrite 机制来对 AOF 文件进行压缩。</p> <h2 id="_1、何为rewrite"><a href="#_1、何为rewrite" class="header-anchor">#</a> 1、何为rewrite</h2> <p>所谓 Rewrite 其实就是对 AOF 文件进行重写整理的过程。当 Rewrite 开启后，主进程 redis-server会创建出一个子进程 <strong>bgrewriteaof</strong>，由该子进程完成 rewrite 过程。其首先对现有 aof 文件进行 rewrite 计算，将计算结果写入到一个临时文件，写入完毕后，再 rename 该临时文件为原 aof文件名，覆盖原有文件。</p> <h2 id="_2、rewrite计算"><a href="#_2、rewrite计算" class="header-anchor">#</a> 2、rewrite计算</h2> <p>rewrite 计算也称为rewrite 策略。rewrite 计算遵循以下策略：<br>●  读操作命令不写入文件；<br>●  无效命令不写入文件；<br>●  过期数据不写入文件；<br>●  多条命令合并写入文件。<br>通过对aof文件进行rewrite计算整理，aof文件中的内容会大大减少，从而减轻了磁盘占用，当rewrite计算完成后，这个新的小aof文件会通过重命名覆盖掉之前的大aof文件。</p> <h2 id="_3、手动开启rewrite"><a href="#_3、手动开启rewrite" class="header-anchor">#</a> 3、手动开启rewrite</h2> <p>Rewrite 过程的执行有两种方式。一种是通过 <code>bgrewriteaof</code> 命令手动开启，一种是通过设置条件自动开启。<br>手动开启rewrite：<br><img src="https://cdn.jsdelivr.net/gh/scr1pt-yang/mypichost@main/img/redis-132.png" alt="image.png"><br>该命令会使主进程redis-server 创建出一个子进程 bgrewriteaof，由该子进程完成 rewrite过程。而在rewrite 期间，redis-server 仍是可以对外提供读写服务的。</p> <h2 id="_4、自动开启rewrite"><a href="#_4、自动开启rewrite" class="header-anchor">#</a> 4、自动开启rewrite</h2> <p>手动方式需要人办干预，所以一般采用自动方式。由于 Rewrite 过程是一个计算过程，需要消耗大量系统资源，会降低系统性能。所以，Rewrite 过程并不是随时随地任意开启的，而是通过设置一些条件，当满足条件后才会启动，以降低对性能的影响。这里的条件可以通过redis的配置文件进行设置。<br>下面是配置文件中对于 Rewrite 自动启动条件的设置。<br><img src="https://cdn.jsdelivr.net/gh/scr1pt-yang/mypichost@main/img/redis-133.png" alt="image.png"><br>●  auto-aof-rewrite-percentage：开启 rewrite 的增大比例，默认 100%。即当aof增量文件占用量增大一倍时启动rewrite；若指定为 0，表示禁用自动 rewrite。<br>●  auto-aof-rewrite-min-size：开启 rewrite 的AOF 文件最小值，默认 64M。相当于设定一个阈值，只有超过64M的aof文件才会进行rewrite；该值的设置主要是为了防止小AOF 文件在增长的过程中一直被 rewrite，从而导致性能下降。<br>自动重写 AOF 文件。当 AOF 日志文件大小增长到指定的百分比时，Redis 主进程redis-server 会 fork 出一个子进程 bgrewriteaof 来完成 rewrite 过程。<br>其工作原理如下：Redis 会记住最新 rewrite 后的 AOF 文件大小作为基本大小，如果从主机启动后就没有发生过重写，则基本大小就使用启动时 AOF 的大小。<br><strong>如果当前 AOF 文件大于基本大小的配置文件中指定的百分比阈值，且当前 AOF 文件大于配置文件中指定的最小阈值，则会触发 rewrite。</strong></p> <h1 id="四、aof-优化配置"><a href="#四、aof-优化配置" class="header-anchor">#</a> 四、AOF 优化配置</h1> <h2 id="_1、appendfsync"><a href="#_1、appendfsync" class="header-anchor">#</a> 1、appendfsync</h2> <p><img src="https://cdn.jsdelivr.net/gh/scr1pt-yang/mypichost@main/img/redis-134.png" alt="image.png"><br>实际上，在执行了写操作命令后，该命令会首先写入到 aof_buf 中，这是一个缓冲区，而后会再持久化到磁盘AOF文件中，当客户端提交了写操作命令后，该命令就会写入到 aof_buf，而从 aof_buf 中的数据持久化到磁盘 AOF 文件的过程称为<strong>数据同步</strong>。<br>那么何时将 aof_buf 中的数据同步到 AOF 文件中呢？这里采用不同的数据同步策略，同步的时机是不同的，有三种策略：<br>●  always：写操作命令写入 aof_buf 后会立即调用fsync()系统函数，将其追加到 AOF 文件。该策略效率较低，但相对比较安全，不会丢失太多数据。最多就是刚刚执行过的写操作在尚未同步时出现宕机或重启，将这一操作丢失。<br>●  no：写操作命令写入 aof_buf 后什么也不做，不会调用 fsync()函数。而将 aof_buf 中的数据同步磁盘的操作交给操作系统来负责。Linux 系统默认同步周期为 30 秒。效率较高。<br>●  everysec：默认策略。写操作命令写入 aof_buf 后并不直接调用fsync()，而是每秒调用一次fsync()系统函数来完成同步。该策略兼顾到了性能与安全，是一种折中方案。</p> <h2 id="_2、no-appendfsync-on-rewrite"><a href="#_2、no-appendfsync-on-rewrite" class="header-anchor">#</a> 2、no-appendfsync-on-rewrite</h2> <p><img src="https://cdn.jsdelivr.net/gh/scr1pt-yang/mypichost@main/img/redis-135.png" alt="image.png"><br>该属性用于指定，当 AOF fsync 策略设置为 always 或everysec，当主进程创建了子进程正在执行 bgsave 或 bgrewriteaof 时，主进程是否不调用 fsync()来做数据同步。设置为 no，双重否定即肯定，主进程会调用 fsync()做同步。而yes 则不会调用 fsync()做数据同步。<br>如果调用fsync()，在需要同步的数据量非常大时，会阻塞主进程对外提供服务，即会存在延迟问题。如果不调用 fsync()，则 AOF fsync 策略相当于设置为了 no，可能会存在 30 秒数据丢失的风险。<br>这里比较绕，再引入一段解释。</p> <div class="custom-block tip"><p class="title"></p><p>关于aof的原理，类似于预写日志，不再解释。其中几个选项如下：
appendfsync always:总是写入aof文件，并完成磁盘同步
appendfsync everysec:每一秒写入aof文件，并完成磁盘同步
appendfsync no:自己不管同步，交给操作系统。
可见，从持久化角度讲，always是最安全的。从效率上讲，no是最快的。而redis默认设置进行了折中，选择了everysec。合情合理。使用bgrewriteaof机制，在一个子进程中进行aof的重写，从而不阻塞主进程对其余命令的处理，同时解决了aof文件过大问题。
现在问题出现了，同时在执行bgrewriteaof操作和主进程写aof文件的操作，两者都会操作磁盘，而bgrewriteaof往往会涉及大量磁盘操作，这样就会造成主进程在写aof文件的时候出现阻塞的情形，现在no-appendfsync-on-rewrite参数出场了。如果该参数设置为 no，是最安全的方式，不会丢失数据，但是要忍受阻塞的问题。如果设置为 yes 呢？这就相当于将appendfsync设置为no，这说明并没有执行磁盘操作，只是写入了缓冲区，因此这样并不会造成阻塞（因为没有竞争磁盘），但是如果这个时候redis挂掉，就会丢失数据。丢失多少数据呢？在Iinux的操作系统的默认设置下，最多会丢失30s的数据。
因此，如果应用系统无法忍受延迟，而可以容忍少量的数据丢失，则设置为yes。如果应用系统无法忍受数据丢失，则设置为no。</p></div><h2 id="_3、aof-rewrite-incremental-fsync"><a href="#_3、aof-rewrite-incremental-fsync" class="header-anchor">#</a> 3、aof-rewrite-incremental-fsync</h2> <p><img src="https://cdn.jsdelivr.net/gh/scr1pt-yang/mypichost@main/img/redis-136.png" alt="image.png"><br>前面说过 bgrewriteaof 在执行过程中先将 rewrite 计算的结果写入到一个临时文件中，其实在写入临时文件的之前会先写到 aof_rewrite_buf 缓存中，然后当缓存中数据达到一定量后就会调用 fsync()进行刷盘操作，即数据同步，将数据写入到临时文件。该属性用于控制 fsync()每次刷盘的数据量最大不超过 4MB。这样可以避免由于单次刷盘量过大而引发长时间阻塞。</p> <h2 id="_4、aof-load-truncated"><a href="#_4、aof-load-truncated" class="header-anchor">#</a> 4、aof-load-truncated</h2> <p><img src="https://cdn.jsdelivr.net/gh/scr1pt-yang/mypichost@main/img/redis-137.png" alt="image.png"><br>在进行 AOF 持久化过程中可能会出现系统突然宕机的情况，此时写入到 AOF 文件中的最后一条数据可能会不完整。当主机启动后，Redis 在 AOF 文件不完整的情况下是否可以启动，取决于属性aof-load-truncated 的设置。其值为：<br>●  yes：AOF 文件最后不完整的数据直接从 AOF 文件中截断删除，不影响Redis 的启动。<br>●  no：AOF 文件最后不完整的数据不可以被截断删除，Redis 无法启动。<br>如果是AOF文件中间出现损坏数据不完整的情况，没有办法，Redis无法启动，此时可以使用<code>redis-check-aof --fix</code>进行修复，但不会完好如初，而是将其从损坏部分开始截断，只保留前半部分完好的，此时会造成数据丢失。</p> <h2 id="_5、aof-timestamp-enabeld"><a href="#_5、aof-timestamp-enabeld" class="header-anchor">#</a> 5、aof-timestamp-enabeld</h2> <p><img src="https://cdn.jsdelivr.net/gh/scr1pt-yang/mypichost@main/img/redis-138.png" alt="image.png"><br>该属性设置为yes 则会开启在 AOF 文件中增加时间戳的显示功能，可方便按照时间对数据进行恢复。但该方式可能会与 AOF 解析器不兼容，所以默认值为 no，不开启。</p> <h1 id="五、aof持久化过程"><a href="#五、aof持久化过程" class="header-anchor">#</a> 五、AOF持久化过程</h1> <p><img src="https://cdn.jsdelivr.net/gh/scr1pt-yang/mypichost@main/img/redis-139.png" alt="image.png"><br>AOF 详细的持久化过程如下：<br>1)  Redis 接收到的写操作命令并不是直接追加到磁盘的AOF 文件的，而是将每一条写命令按照redis 通讯协议格式暂时添加到 AOF 缓冲区 <code>aof_buf</code>。<br>2)  根据设置的数据同步策略，当同步条件满足时，再将缓冲区中的数据一次性写入磁盘的AOF 文件，以减少磁盘 IO 次数，提高性能。<br>3)  当磁盘的 AOF 文件大小达到了rewrite 条件时，redis-server 主进程会fork 出一个子进程bgrewriteaof，由该子进程完成 rewrite 过程。<br>4)  子进程 bgrewriteaof 首先对该磁盘 AOF 文件进行 rewrite 计算，将计算结果写入到一个临时文件，全部写入完毕后，再 rename 该临时文件为磁盘文件的原名称，覆盖原文件。<br>5)  如果在 rewrite 过程中又有写操作命令追加，那么这些数据会暂时写入 aof_rewrite_buf缓冲区。等将全部rewrite 计算结果写入临时文件后，会先将 aof_rewrite_buf 缓冲区中的数据写入临时文件，然后再rename 为磁盘文件的原名称，覆盖原文件。</p> <h1 id="六、rdb-与-aof-对比"><a href="#六、rdb-与-aof-对比" class="header-anchor">#</a> 六、RDB 与 AOF 对比</h1> <p>RDB（Redis Database）持久化技术和AOF（Append-Only File）持久化技术是Redis用于数据持久化的两种主要方式。它们各自具有一些优点和不足：<br>RDB持久化技术的优点：</p> <ol><li>高效性：RDB是一种紧凑且高效的快照机制，它将Redis在某个时间点的数据状态保存到磁盘上的一个二进制文件中。这种方式非常适合用于定期备份和数据迁移。</li> <li>性能较好：由于RDB是通过生成一个快照来进行持久化，所以它对系统的性能影响较小。在某些情况下，可以使用RDB来实现更好的性能和响应时间。</li> <li>容易恢复：将Redis恢复到RDB快照所代表的状态非常简单，只需将快照文件加载到Redis服务器即可。</li></ol> <p>RDB持久化技术的不足：</p> <ol><li>数据丢失风险：由于RDB是基于某个时间点的快照，如果Redis发生故障或意外关闭，那么在最后一次生成快照之后的所有更新将会丢失。</li> <li>不适合实时数据：RDB是定期生成快照的方式，因此在两次快照之间的数据更新都无法被持久化。如果需要保证实时数据的一致性，RDB可能不太适合。</li></ol> <p>AOF持久化技术的优点：</p> <ol><li>可靠性：AOF以日志追加的方式记录每个写操作命令，这意味着即使Redis发生故障或意外关闭，也可以通过重新执行AOF日志文件中的命令来还原数据，减少了数据丢失的风险。</li> <li>数据完整性：AOF记录的是写操作命令，因此它可以准确地反映出Redis服务器接收到的每一个写操作，包括过期、删除和修改等操作，从而保证了数据的完整性。</li> <li>实时性：AOF支持更频繁的持久化操作，可以通过配置不同的策略来控制写入AOF日志文件的频率，从而实现更高的数据实时性。</li></ol> <p>AOF持久化技术的不足：</p> <ol><li>文件体积较大：AOF日志文件通常会比RDB快照文件大，因为它需要记录每个写操作的详细信息。这可能会导致AOF文件的体积相对较大，占用更多的磁盘空间。</li> <li>恢复速度较慢：由于AOF记录了每个写操作命令，所以在恢复时需要重新执行所有的命令，这可能导致恢复速度较慢。</li> <li>对性能的影响：AOF持久化可能对Redis的写入性能产生一定的影响，特别是在频繁写入的情况下。为了平衡性能和持久化的需求，可以通过调整AOF的同步策略来进行优化。</li></ol> <p>综上所述，RDB持久化技术适用于定期备份和数据迁移，具有高效性和较好的性能，但可能存在数据丢失的风险。而AOF持久化技术以日志追加的方式记录每个写操作命令，具有较高的可靠性和实时性，但可能会占用更多的磁盘空间，并对写入性能产生一定的影响。根据实际需求和场景，可以选择合适的持久化方式或结合两种方式来使用。<br>●  官方推荐使用RDB 与 AOF 混合式持久化。<br>●  若对数据安全性要求不高，则推荐使用纯 RDB 持久化方式。<br>●  不推荐使用纯 AOF 持久化方式。<br>●  若 Redis 仅用于缓存，则无需使用任何持久化技术。</p></div></section> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/pages/redis/RDB持久化.html" class="prev">
          17.RDB持久化
        </a></span> <span class="next"><a href="/pages/redis/主从集群搭建.html">
          19.主从集群搭建
        </a></span></p></div> <div class="comments-wrapper" style="display:none;"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-1" data-v-b57cc07c><a href="/pages/redis/AOF%E6%8C%81%E4%B9%85%E5%8C%96.html#一、aof基础配置" class="sidebar-link reco-side-一、aof基础配置" data-v-b57cc07c>一、AOF基础配置</a></li><li class="level-2" data-v-b57cc07c><a href="/pages/redis/AOF%E6%8C%81%E4%B9%85%E5%8C%96.html#_1、开启aof持久化" class="sidebar-link reco-side-_1、开启aof持久化" data-v-b57cc07c>1、开启AOF持久化</a></li><li class="level-2" data-v-b57cc07c><a href="/pages/redis/AOF%E6%8C%81%E4%B9%85%E5%8C%96.html#_2、文件名配置" class="sidebar-link reco-side-_2、文件名配置" data-v-b57cc07c>2、文件名配置</a></li><li class="level-2" data-v-b57cc07c><a href="/pages/redis/AOF%E6%8C%81%E4%B9%85%E5%8C%96.html#_3、混合式持久化" class="sidebar-link reco-side-_3、混合式持久化" data-v-b57cc07c>3、混合式持久化</a></li><li class="level-2" data-v-b57cc07c><a href="/pages/redis/AOF%E6%8C%81%E4%B9%85%E5%8C%96.html#_4、aof-文件目录配置" class="sidebar-link reco-side-_4、aof-文件目录配置" data-v-b57cc07c>4、AOF 文件目录配置</a></li><li class="level-1" data-v-b57cc07c><a href="/pages/redis/AOF%E6%8C%81%E4%B9%85%E5%8C%96.html#二、aof文件格式" class="sidebar-link reco-side-二、aof文件格式" data-v-b57cc07c>二、AOF文件格式</a></li><li class="level-2" data-v-b57cc07c><a href="/pages/redis/AOF%E6%8C%81%E4%B9%85%E5%8C%96.html#_1、redis协议" class="sidebar-link reco-side-_1、redis协议" data-v-b57cc07c>1、Redis协议</a></li><li class="level-2" data-v-b57cc07c><a href="/pages/redis/AOF%E6%8C%81%E4%B9%85%E5%8C%96.html#_2、查看aof文件" class="sidebar-link reco-side-_2、查看aof文件" data-v-b57cc07c>2、查看AOF文件</a></li><li class="level-2" data-v-b57cc07c><a href="/pages/redis/AOF%E6%8C%81%E4%B9%85%E5%8C%96.html#_3、查看清单文件" class="sidebar-link reco-side-_3、查看清单文件" data-v-b57cc07c>3、查看清单文件</a></li><li class="level-1" data-v-b57cc07c><a href="/pages/redis/AOF%E6%8C%81%E4%B9%85%E5%8C%96.html#三、rewrite机制" class="sidebar-link reco-side-三、rewrite机制" data-v-b57cc07c>三、Rewrite机制</a></li><li class="level-2" data-v-b57cc07c><a href="/pages/redis/AOF%E6%8C%81%E4%B9%85%E5%8C%96.html#_1、何为rewrite" class="sidebar-link reco-side-_1、何为rewrite" data-v-b57cc07c>1、何为rewrite</a></li><li class="level-2" data-v-b57cc07c><a href="/pages/redis/AOF%E6%8C%81%E4%B9%85%E5%8C%96.html#_2、rewrite计算" class="sidebar-link reco-side-_2、rewrite计算" data-v-b57cc07c>2、rewrite计算</a></li><li class="level-2" data-v-b57cc07c><a href="/pages/redis/AOF%E6%8C%81%E4%B9%85%E5%8C%96.html#_3、手动开启rewrite" class="sidebar-link reco-side-_3、手动开启rewrite" data-v-b57cc07c>3、手动开启rewrite</a></li><li class="level-2" data-v-b57cc07c><a href="/pages/redis/AOF%E6%8C%81%E4%B9%85%E5%8C%96.html#_4、自动开启rewrite" class="sidebar-link reco-side-_4、自动开启rewrite" data-v-b57cc07c>4、自动开启rewrite</a></li><li class="level-1" data-v-b57cc07c><a href="/pages/redis/AOF%E6%8C%81%E4%B9%85%E5%8C%96.html#四、aof-优化配置" class="sidebar-link reco-side-四、aof-优化配置" data-v-b57cc07c>四、AOF 优化配置</a></li><li class="level-2" data-v-b57cc07c><a href="/pages/redis/AOF%E6%8C%81%E4%B9%85%E5%8C%96.html#_1、appendfsync" class="sidebar-link reco-side-_1、appendfsync" data-v-b57cc07c>1、appendfsync</a></li><li class="level-2" data-v-b57cc07c><a href="/pages/redis/AOF%E6%8C%81%E4%B9%85%E5%8C%96.html#_2、no-appendfsync-on-rewrite" class="sidebar-link reco-side-_2、no-appendfsync-on-rewrite" data-v-b57cc07c>2、no-appendfsync-on-rewrite</a></li><li class="level-2" data-v-b57cc07c><a href="/pages/redis/AOF%E6%8C%81%E4%B9%85%E5%8C%96.html#_3、aof-rewrite-incremental-fsync" class="sidebar-link reco-side-_3、aof-rewrite-incremental-fsync" data-v-b57cc07c>3、aof-rewrite-incremental-fsync</a></li><li class="level-2" data-v-b57cc07c><a href="/pages/redis/AOF%E6%8C%81%E4%B9%85%E5%8C%96.html#_4、aof-load-truncated" class="sidebar-link reco-side-_4、aof-load-truncated" data-v-b57cc07c>4、aof-load-truncated</a></li><li class="level-2" data-v-b57cc07c><a href="/pages/redis/AOF%E6%8C%81%E4%B9%85%E5%8C%96.html#_5、aof-timestamp-enabeld" class="sidebar-link reco-side-_5、aof-timestamp-enabeld" data-v-b57cc07c>5、aof-timestamp-enabeld</a></li><li class="level-1" data-v-b57cc07c><a href="/pages/redis/AOF%E6%8C%81%E4%B9%85%E5%8C%96.html#五、aof持久化过程" class="sidebar-link reco-side-五、aof持久化过程" data-v-b57cc07c>五、AOF持久化过程</a></li><li class="level-1" data-v-b57cc07c><a href="/pages/redis/AOF%E6%8C%81%E4%B9%85%E5%8C%96.html#六、rdb-与-aof-对比" class="sidebar-link reco-side-六、rdb-与-aof-对比" data-v-b57cc07c>六、RDB 与 AOF 对比</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><canvas id="vuepress-canvas-cursor"></canvas><canvas id="vuepress-canvas-ribbon"></canvas><!----></div></div>
    <script src="/assets/js/app.b91711c7.js" defer></script><script src="/assets/js/7.9d515fbf.js" defer></script><script src="/assets/js/2.5da332ff.js" defer></script><script src="/assets/js/1.4298cda3.js" defer></script><script src="/assets/js/67.85226520.js" defer></script>
  </body>
</html>
